{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "circuitName": {
            "type": "string",
            "defaultValue": "BoklynTestCircuit",
            "metadata": {
                "description": "1.This is the name of the ExpressRoute circuit"
            }
        },
        "serviceProviderName": {
            "type": "string",
            "defaultValue": "MSIT",
            "metadata": {
                "description": "1.This is the name of the ExpressRoute Service Provider. It must exactly match one of the Service Providers from List ExpressRoute Service Providers API call."
            }
        },
        "peeringLocation": {
            "type": "string",
            "defaultValue": "Bay Area 2",
            "metadata": {
                "description": "1.This is the name of the peering location and not the ARM resource location. It must exactly match one of the available peering locations from List ExpressRoute Service Providers API call."
            }
        },
        "bandwidthInMbps": {
            "type": "int",
            "defaultValue": 50,
            "metadata": {
                "description": "1.This is the bandwidth in Mbps of the circuit being created. It must exactly match one of the available bandwidth offers List ExpressRoute Service Providers API call."
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "East US",
            "metadata": {
                "description": "1. and 2. Location where resources would be created."
            }
        },
        "sku_tier": {
            "type": "string",
            "defaultValue": "Standard",
            "allowedValues": [
                "Standard",
                "Premium"
            ],
            "metadata": {
                "description": "1.Chosen SKU Tier of ExpressRoute circuit. Choose from Premium or Standard SKU tiers."
            }
        },
        "sku_family": {
            "type": "string",
            "defaultValue": "MeteredData",
            "allowedValues": [
                "MeteredData",
                "UnlimitedData"
            ],
            "metadata": {
                "description": "1.Chosen SKU family of ExpressRoute circuit. Choose from MeteredData or UnlimitedData SKU families."
            }
        },
        "peeringType": {
            "type": "string",
            "defaultValue": "AzurePrivatePeering",
            "allowedValues": [
                "AzurePrivatePeering",
                "AzurePublicPeering",
                "MicrosoftPeering"
            ],
            "metadata": {
                "description": "1.BGP peering type for the Circuit. Choose from AzurePrivatePeering, AzurePublicPeering or MicrosoftPeering."
            }
        },
        "gatewayType": {
            "type": "string",
            "defaultValue": "ExpressRoute",
            "allowedValues": [
                "ExpressRoute"
            ],
            "metadata": {
                "description": "The type of gateway to deploy. For connecting to ExpressRoute circuits, the gateway must be of type ExpressRoute. Other types are Vpn."
            }
        },
        "connectionType": {
            "type": "string",
            "defaultValue": "ExpressRoute",
            "allowedValues": [
                "ExpressRoute"
            ],
            "metadata": {
                "description": "The type of connection. For connecting to ExpressRoute circuits, the connectionType must be of type ExpressRoute. Other types are IPsec and Vnet2Vnet."
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "defaultValue": "TestARMVnet1",
            "metadata": {
                "description": "The name of the virtual network to create."
            }
        },
        "addressPrefix": {
            "type": "string",
            "defaultValue": "192.168.0.0/16",
            "metadata": {
                "description": "The address space in CIDR notation for the new virtual network."
            }
        },
        "subnetName1": {
            "type": "string",
            "defaultValue": "Backend",
            "metadata": {
                "description": "The name of the first subnet in the new virtual network."
            }
        },
        "subnetName2": {
            "type": "string",
            "defaultValue": "Frontend",
            "metadata": {
                "description": "The name of the first subnet in the new virtual network."
            }
        },
        "gatewaySubnet": {
            "type": "string",
            "defaultValue": "GatewaySubnet",
            "allowedValues": [
                "GatewaySubnet"
            ],
            "metadata": {
                "description": "The name of the subnet where Gateway is to be deployed. This must always be named GatewaySubnet."
            }
        },
        "subnetPrefix1": {
            "type": "string",
            "defaultValue": "192.168.1.0/24",
            "metadata": {
                "description": "The address range in CIDR notation for the first subnet."
            }
        },
        "subnetPrefix2": {
            "type": "string",
            "defaultValue": "192.168.2.0/24",
            "metadata": {
                "description": "The address range in CIDR notation for the first subnet."
            }
        },
        "gatewaySubnetPrefix": {
            "type": "string",
            "defaultValue": "192.168.3.0/28",
            "metadata": {
                "description": "The address range in CIDR notation for the Gateway subnet. For ExpressRoute enabled Gateways, this must be minimum of /28."
            }
        },
        "gatewayPublicIPName": {
            "type": "string",
            "defaultValue": "MSITTestGWIP2",
            "metadata": {
                "description": "The resource name given to the public IP attached to the gateway."
            }
        },
        "gatewayName": {
            "type": "string",
            "defaultValue": "MSITGaterway2",
            "metadata": {
                "description": "The resource name given to the ExpressRoute gateway."
            }
        },
        "connectionName": {
            "type": "string",
            "defaultValue": "TheConnection",
            "metadata": {
                "description": "The resource name given to the Connection which links VNet Gateway to ExpressRoute circuit."
            }
        },
        "vlanId": {
            "type": "int",
            "defaultValue": 900,
            "metadata": {
                "description": "Specifies the identifier that is used to identify the customer."
            }
        }
    },
    "variables": {
        "apiVersion": "2015-06-15",
        "vnetID": "[resourceId('Microsoft.Network/virtualNetworks',parameters('virtualNetworkName'))]",
        "gatewaySubnetRef": "[concat(variables('vnetID'),'/subnets/',parameters('gatewaySubnet'))]",
        "routingWeight": 3
    },
    "resources": [
        {
            "apiVersion": "2015-05-01-preview",
            "type": "Microsoft.Network/expressRouteCircuits",
            "name": "[parameters('circuitName')]",
            "location": "[parameters('location')]",
            "tags": {
                "key1": "value1",
                "key2": "value2"
            },
            "sku": {
                "name": "[concat(parameters('sku_tier'),'_', parameters('sku_family'))]",
                "tier": "[parameters('sku_tier')]",
                "family": "[parameters('sku_family')]"
            },
            "properties": {
                "serviceProviderProperties": {
                    "serviceProviderName": "[parameters('serviceProviderName')]",
                    "peeringLocation": "[parameters('peeringLocation')]",
                    "bandwidthInMbps": "[parameters('bandwidthInMbps')]"
                },
                "peerings": [
                    {
                        "name": "[parameters('peeringType')]",
                        "properties": {
                            "peeringType": "[parameters('peeringType')]",
                            "vlanId": "[parameters('vlanId')]"
                        }
                    }
                ]
            },
            "resources": 
            [
                {
                    "apiVersion": "[variables('apiVersion')]",
                    "type": "Microsoft.Network/virtualNetworks",
                    "name": "[parameters('virtualNetworkName')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                        "[concat('Microsoft.Network/expressRouteCircuits/', parameters('circuitName'))]"
                    ],
                    "properties": {
                        "addressSpace": {
                            "addressPrefixes": [
                                "[parameters('addressPrefix')]"
                            ]
                        },
                        "subnets": [
                            {
                                "name": "[parameters('subnetName1')]",
                                "properties": {
                                    "addressPrefix": "[parameters('subnetPrefix1')]"
                                }
                            },
                            {
                                "name": "[parameters('subnetName2')]",
                                "properties": {
                                    "addressPrefix": "[parameters('subnetPrefix2')]"
                                }
                            },
                            {
                                "name": "[parameters('gatewaySubnet')]",
                                "properties": {
                                    "addressPrefix": "[parameters('gatewaySubnetPrefix')]"
                                }
                            }
                        ]
                    }
                },
                {
                    "apiVersion": "[variables('apiVersion')]",
                    "type": "Microsoft.Network/publicIPAddresses",
                    "name": "[parameters('gatewayPublicIPName')]",
                    "location": "[parameters('location')]",
                    "properties": {
                        "publicIPAllocationMethod": "Dynamic"
                    }
                },
                {
                    "apiVersion": "[variables('apiVersion')]",
                    "type": "Microsoft.Network/virtualNetworkGateways",
                    "name": "[parameters('gatewayName')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                        "[concat('Microsoft.Network/publicIPAddresses/', parameters('gatewayPublicIPName'))]",
                        "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]"
                    ],
                    "properties": {
                        "ipConfigurations": [
                            {
                                "properties": {
                                    "privateIPAllocationMethod": "Dynamic",
                                    "subnet": {
                                        "id": "[variables('gatewaySubnetRef')]"
                                    },
                                    "publicIPAddress": {
                                        "id": "[resourceId('Microsoft.Network/publicIPAddresses',parameters('gatewayPublicIPName'))]"
                                    }
                                },
                                "name": "vnetGatewayConfig"
                            }
                        ],
                        "gatewayType": "[parameters('gatewayType')]"
                    }
                },
                { 
                    "apiVersion": "[variables('apiVersion')]",
                    "type": "Microsoft.Network/connections",
                    "name": "[parameters('connectionName')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                        "[concat('Microsoft.Network/virtualNetworkGateways/', parameters('gatewayName'))]",
                        "[concat('Microsoft.Network/expressRouteCircuits/', parameters('circuitName'))]"
                    ],
                    "properties": {
                        "virtualNetworkGateway1": {
                            "id": "[resourceId('Microsoft.Network/virtualNetworkGateways/',parameters('gatewayName'))]"
                        },
                        "peer": {
                            "id": "[resourceId('Microsoft.Network/expressRouteCircuits/',parameters('circuitName'))]"
                        },
                        "connectionType": "[parameters('connectionType')]",
                        "routingWeight": "[variables('routingWeight')]"
                    }
                }
            ]
        }
    ]
}